# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is "Make It Red", a sample plugin for Zotero 7 that demonstrates the evolution of Zotero plugin architecture across multiple versions. The plugin serves as a reference implementation showing migration paths from Zotero 6 overlay plugins to modern Zotero 7 plugins.

## Build Commands

```bash
# Build all plugin versions (creates XPI files in build/)
./make-zips

# Build TypeScript only (for src-2.0 development)
npm run build:2.0

# Watch mode for TypeScript development
npm run watch:2.0
```

The `make-zips` script:
- Compiles TypeScript for src-2.0 (`npm run build:2.0`)
- Creates XPI packages from each src-X.X folder
- Generates update manifests with SHA256 hashes
- Sets up update chains allowing upgrades between versions

## Testing and Development

**Manual Testing**: Install XPIs via Zotero Add-ons window, or see [Setting Up a Plugin Development Environment](https://www.zotero.org/support/dev/client_coding/plugin_development#setting_up_a_plugin_development_environment) to run from source.

**No automated tests**: This is a reference plugin demonstrating patterns, not a production codebase with test infrastructure.

## Architecture Overview

### Version Structure

The codebase contains four evolutionary versions demonstrating different plugin architectures:

- **src-1.0**: Overlay plugin for Zotero 6 (legacy XUL overlay architecture)
- **src-1.1**: Hybrid plugin (overlay for Zotero 6, bootstrap for Zotero 7)
- **src-1.2**: Bootstrapped plugin for both Zotero 6 and 7
- **src-2.0**: Native Zotero 7 plugin (modern, simplified)

### Plugin Lifecycle (Bootstrap Pattern)

Bootstrap plugins (src-1.2 and src-2.0) follow this lifecycle:

1. **startup()** - Called when plugin loads
   - In src-1.2: Includes `waitForZotero()` for async initialization and platform detection
   - Loads `make-it-red.js` via `Services.scriptloader.loadSubScript()`
   - Calls `MakeItRed.init()`, `MakeItRed.addToAllWindows()`, `MakeItRed.main()`

2. **onMainWindowLoad()** - Called for each Zotero window
   - Calls `MakeItRed.addToWindow(window)` to inject UI elements

3. **onMainWindowUnload()** - Called when window closes
   - Calls `MakeItRed.removeFromWindow(window)` for cleanup

4. **shutdown()** - Called when plugin unloads
   - Calls `MakeItRed.removeFromAllWindows()`
   - Cleans up global `MakeItRed` object

### Core Plugin Pattern

Each version implements a singleton `MakeItRed` object with these key methods:

```javascript
MakeItRed = {
  init({ id, version, rootURI })     // Initialize plugin metadata
  addToWindow(window)                 // Inject UI into specific window
  addToAllWindows()                   // Apply to all open Zotero windows
  removeFromWindow(window)            // Clean up from specific window
  removeFromAllWindows()              // Clean up from all windows
  storeAddedElement(elem)             // Track elements for cleanup
  main()                              // Main async initialization logic
}
```

The `addedElementIDs` array tracks all created DOM elements to ensure proper cleanup on shutdown.

### Key Architectural Differences

**src-1.2 (Zotero 6/7 compatibility)**:
- Uses `document.createElementNS()` for XUL elements
- Includes `waitForZotero()` to handle async initialization
- Platform version detection: `Zotero.platformMajorVersion < 102`
- Loads preference defaults via `setDefaultPrefs()` in bootstrap

**src-2.0 (Zotero 7 only)**:
- **Written in TypeScript** with full type safety
- Source files in `src-2.0/src/` (`.ts` files)
- Compiled output in `src-2.0/build/` (`.js` files)
- Type definitions in `src-2.0/src/types.d.ts`
- Uses modern `createXULElement()` method
- Assumes `Zotero` is always available at startup
- Uses optional chaining (`?.`) freely
- Registers preferences via `Zotero.PreferencePanes.register()`
- Simplified manifest.json without install.rdf

### Configuration Files

**Manifests**:
- `install.rdf` (src-1.0 to src-1.2): Mozilla RDF format with plugin metadata
- `manifest.json` (src-1.1 to src-2.0): WebExtension-style manifest with version constraints
- src-2.0 uses only `manifest.json`

**Chrome Manifest** (`chrome.manifest` in src-1.0 to src-1.2):
- Maps virtual `chrome://` URIs to physical file paths
- Registers content, localization, and skin resources
- Not needed in src-2.0

**Update Manifests**:
- Template files: `updates-X.X.json.tmpl`
- Generated by `make-zips` with SHA256 hashes
- Demonstrates update chains: 1.0 → 1.1 → 1.2 → 2.0
- Allows direct upgrades to 2.0 from Zotero 7

### Localization

- **src-1.0**: Uses `.properties` files (key=value format)
- **src-1.1+**: Uses Fluent format (`.ftl` files) with `.properties` fallback for Zotero 6
- Location: `locale/en-US/` for Fluent, `chrome/locale/en-US/` for legacy

### Styling

- CSS injected dynamically via `<link>` element in bootstrap versions
- Uses attribute selectors for feature toggling: `window[data-green-instead]`
- Loaded from `rootURI` using `Services.io.newURI()`

## Important Notes for Development

### When Working with src-2.0 (Modern Zotero 7 with TypeScript)

- **Source files**: Edit TypeScript files in `src-2.0/src/` directory
- **Build process**: Run `npm run build:2.0` to compile to `src-2.0/build/`
- **Type safety**: Use the types defined in `types.d.ts` for Zotero APIs
- This version assumes Zotero 7.0+ and drops all Zotero 6 compatibility
- Use `createXULElement()` instead of `createElementNS()`
- No need to check if `Zotero` is defined - it's always available
- Preference registration happens via `Zotero.PreferencePanes.register()`

### When Working with src-1.2 (Compatible Version)

- Must handle both Zotero 6 and 7 differences
- Always check `Zotero.platformMajorVersion` for Firefox version
- Use `waitForZotero()` to ensure `Zotero` object is available
- Load preference defaults in bootstrap for Zotero 6 compatibility

### DOM Element Management

All dynamically created elements must be:
1. Created with appropriate namespace/method for the target version
2. Registered via `storeAddedElement(elem)` for cleanup tracking
3. Removed during shutdown in `removeFromWindow()` or `removeFromAllWindows()`

This ensures clean uninstallation without leaving artifacts in Zotero's UI.

### Plugin ID

The plugin ID is `make-it-red@example.com`. Note that recent commits changed the domain from `zotero.org` to `example.com` - this is intentional for sample/template plugins.

## Technology Stack

- **Language**:
  - TypeScript for src-2.0 (compiled to ES2020)
  - Pure JavaScript (ES6+ with async/await) for src-1.0 through src-1.2
- **Build tools**:
  - TypeScript compiler 5.3+ for src-2.0
  - Direct JavaScript files (no build) for src-1.x versions
- **Development dependencies**:
  - `typescript` ^5.3.0
  - `@types/node` ^20.0.0
- **Runtime**: Standalone plugin using only Zotero and Firefox APIs
